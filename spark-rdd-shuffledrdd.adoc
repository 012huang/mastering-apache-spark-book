== ShuffledRDD

*ShuffledRDD* is the result RDD of a transformation that triggers link:spark-rdd-shuffle.adoc[shuffle] at execution. Such a transformation ultimately call `coalesce` transformation with `shuffle` input parameter `true` (default: `false`).

Let's have a look at the below example with `groupBy` transformation:

```
scala> val r = sc.parallelize(0 to 9, 3).groupBy(_ / 3)
r: org.apache.spark.rdd.RDD[(Int, Iterable[Int])] = ShuffledRDD[2] at groupBy at <console>:18

scala> r.toDebugString
res0: String =
(3) ShuffledRDD[2] at groupBy at <console>:18 []
 +-(3) MapPartitionsRDD[1] at groupBy at <console>:18 []
    |  ParallelCollectionRDD[0] at parallelize at <console>:18 []
```

As you may have noticed, `groupBy` transformation adds `ShuffledRDD` RDD that will execute shuffling at execution time (as depicted in the following screenshot).

.Two stages in a job due to shuffling
image::images/spark-webui-job-two-stages.png[align="center"]

It's also known as *a shuffle step* (see https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/rdd/RDD.scala#L403[this line in org/apache/spark/rdd/RDD.scala]).

A parent RDD is a pair RDD which means ShuffleRDD works with RDDs of pairs.

It is also the result of RDD transformations using Scala implicits:

* `repartitionAndSortWithinPartitions`
* `sortByKey` (be very careful due to https://issues.apache.org/jira/browse/SPARK-1021[[SPARK-1021\]
sortByKey() launches a cluster job when it shouldn't])
* `combineByKeyWithClassTag` (only when the input partitioner is different from the current one in an RDD)
* `partitionBy` (only when the input partitioner is different from the current one in an RDD)

It uses link:spark-rdd-partitions.adoc#partitioner[Partitioner].

ShuffledRDD's RDD Dependencies are always a single-element link:spark-rdd-dependencies.adoc#ShuffleDependency[ShuffleDependency]. Partitions are of type `ShuffledRDDPartition`.

It uses link:spark-service-mapoutputtracker.adoc#MapOutputTrackerMaster[MapOutputTrackerMaster] to get preferred locations for a shuffle, i.e. a ShuffleDependency.

[CAUTION]
====
FIXME

* Where's `mapSideCombine` flag used?
====
